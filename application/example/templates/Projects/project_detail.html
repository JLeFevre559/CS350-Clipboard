<!DOCTYPE html>
{% extends 'theme.html' %}
{% load static %}

{% block title %}
{% endblock title %}


{% block content %}
<body>
    <h1 class="text-primary">Project Details: {{ project.name }}</h1>
    <div class="project-buttons">
        <a href="{% url 'project-update' project.id%}"><button class="project-button">Edit Project</button></a>
        <a href="{% url 'project-delete' project.id %}"><button class="delete-button" >Delete Project</button></a>
    </div>
    <p>Description: <b>{{ project.description }}<b></p>
    <button class="create-tasklist-button project-button" data-project-id="{{ project.id }}">Create new tasklist</button>
    <h2>Tasklists:</h2>
    <div class="projectdiv">
        {% for tasklist in tasklists %}
            <div class="task-list temp" id="{{ tasklist.id }}-tasklist">
                <div  class="task-list-info">
                    <h3 class="task-list-info" id="{{ tasklist.id }}-text">
                        {{ tasklist.name }}
                    </h3> 
                    <button class="edit-button" data-task-list="{{ tasklist.id }}" data-task-list-name="{{ tasklist.name }}">
                        <img src="{% static '/images/edit.png' %}" sizes="32x32">
                    </button>
                    <button class="trash-button" data-task-list="{{ tasklist.id }}" onclick="showConfirmationPopup('{{ tasklist.id }}', 'tasklist')">
                        <img src="{% static '/images/trash.png' %}" sizes="32x32">
                    </button>
                </div>
                <div class="task-list">
                    <h3>Status: <span id="taskListStatus" class="status-not-started">Not Started</span></h3>
                </div>
                <div class="tasks temp">
                    {% for task in tasks %}
                        {% if task.task_list == tasklist %}
                            <div class="task">
                                <p><span class="popup-trigger" data-popup-id="popup1">{{ task.task_name }}</span>:<span id="{{ task.id }}-status" class="{{ task.status }}">{{ task.status }}</span></p>
                                <button class="update-status-button" data-status="In Progress" data-task="{{ task.id }}" onclick="updateTaskStatus('{{ task.id }}', 'In Progress')">In Progress</button>
                                <button class="update-status-button" data-status="Done" data-task="{{ task.id }}" onclick="updateTaskStatus('{{ task.id }}', 'Done')">Done</button>
                            </div>
                        {% endif %}
                    {% empty %}
                        <h2>No Tasks</h2>
                    {% endfor %}
                </div>
                <button href="#" class="create-task-button project-button" data-tasklist-id="{{ tasklist.id }}">Add Task</button>
            </div>
        {% empty %}
            <h2>No Tasklists available</h3>
        {% endfor %}
    </div>
    
    
    <a href="/Project"><button class="project-button">Back to Project List</button></a>
</body>

<div class="popup" id="popup1">
<div class="popup-content">
    <ul>
    <li><p>Assigned To: <b>{{ task.assignee }}</b></p></li>
    <li><p>Task: <b>{{ task.name }}</b></p></li>
    <li>
        <p>Description: <b>{{ task.description }}</b> </p>
    </li>
    <li>
        <p>Due Date: <b>{{task.due_date}}</b></p>
    </li>
    <li>
        <div class="container">
        <div>
            <button class="update-status-button" data-status="In Progress">In Progress</button>
            <button class="update-status-button" data-status="Done">Done</button>
        </div>
        <h4>{{ task.due_date }} </h4>
        <button class="close-popup">Close</button>
        </div>
    </li>
    </ul>   
</div>
</div>

<div class="popup" id="createTasklistPopup">
<div class="popup-content">
    <h3>Create New Tasklist</h3>
    <form method="post" action="{% url 'create-tasklist' %}">
        {% csrf_token %}
        <!-- Include a hidden input to store the project ID -->
        <input type="hidden" name="project_id" value="">
        <label for="tasklist_name">Tasklist Name:</label>
        <input type="text" name="tasklist_name" id="tasklist_name" required>
        <button type="submit">Create</button>
        <button class="close-popup">Cancel</button>
    </form>
</div>
</div>

<div class="popup" id="createTaskPopup">
<div class="popup-content">
    <h3>Create New Task</h3>
    <form method="post" action="{% url 'create-task' %}">
        {% csrf_token %}
        <!-- Include a hidden input to store the tasklist ID -->
        <input type="hidden" name="tasklist_id" value="{{ tasklist.id }}">
        <label for="task_name">Task Name:</label>
        <input type="text" name="task_name" id="task_name" required>
        <label for="description">Description:</label>
        <textarea name="description" id="description"></textarea>
        <label for="due_date">Due Date:</label>
        <input type="date" name="due_date" id="due_date">
        <label for="priority">Priority:</label>
        <select name="priority" id="priority">
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
        </select>
        <button type="submit">Create</button>
        <button class="close-popup">Cancel</button>
    </form>
</div>
</div>

<div class="popup" id="editTasklistPopup">
    <div class="popup-content">
        <h3>Edit Tasklist</h3>
        <form method="post" id="editTasklistForm">
            {% csrf_token %}
            <input type="hidden" name="tasklist_id" id="editTasklistId" value="">
            <label for="editTasklistName">New Tasklist Name:</label>
            <input type="text" name="new_name" id="editTasklistName" required>
            <button type="submit">Save</button>
            <button class="close-popup">Cancel</button>
        </form>
    </div>
</div>

<div class="popup" id="confirmationPopup">
    <div class="popup-content">
        <h3 id="confirmationTitle"></h3>
        <p id="confirmationMessage"></p>
        <button id="confirmActionButton" class="project-button">Yes</button>
        <button class="close-popup">No</button>
    </div>
</div>

<script>
const triggers = document.querySelectorAll('.popup-trigger');
const popups = document.querySelectorAll('.popup');
const closeButtons = document.querySelectorAll('.close-popup');

// Function to show a specific popup by ID
function showPopup(popupId) {
    const popup = document.getElementById(popupId);
    if (popup) {
        popup.style.display = 'block';
    }
}

// Function to hide a specific popup by ID
function hidePopup(popupId) {
    const popup = document.getElementById(popupId);
    if (popup) {
        popup.style.display = 'none';
    }
}

// Add click event listeners to all trigger elements
triggers.forEach(trigger => {
    trigger.addEventListener('click', function () {
        const popupId = this.getAttribute('data-popup-id');
        showPopup(popupId);
    });
});

// Add click event listeners to close buttons
closeButtons.forEach(closeButton => {
    closeButton.addEventListener('click', function () {
        const popupId = this.closest('.popup').id;
        hidePopup(popupId);
    });
});



function updateTaskStatus(taskId, newStatus) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // Send an AJAX request to update the task status
    $.ajax({
        url: '/update_task_status/',
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        data: JSON.stringify({
            task_id: taskId,
            new_status: newStatus,
        }),
        success: function (response) {
            // Handle the success response (e.g., display a message)
            console.log(response.message);
            // Update the task status wherever it's displayed
            const buttonToUpdate = document.querySelector(`[data-task="${taskId}"]`);
            // Update the class of the <span> element
            const spanToUpdate = document.getElementById(`${taskId}-status`);
            if (spanToUpdate) {
                spanToUpdate.className = `status-${newStatus}`;
                spanToUpdate.textContent = newStatus;
            }
        },
        error: function (xhr, textStatus, errorThrown) {
            // Handle errors (e.g., display an error message)
            console.error(xhr.responseText);
        }
    });
}

function editTaskList(tasklist_id, name){
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;


    // Send an AJAX request to update the tasklist
    $.ajax({
        url: '/update_task_list/',
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        data: JSON.stringify({
            tasklist_id: tasklist_id,
            name: name,
        }),
        success: function (response) {
            // Handle the success response (e.g., display a message)
            console.log(response.message);

            // Update the tasklist name in the UI
            const tasklistHeader = document.querySelector(`[id="${tasklist_id}-text"]`);
            if (tasklistHeader) {
                tasklistHeader.textContent = name;
            }
        },
        error: function (xhr, textStatus, errorThrown) {
            // Handle errors (e.g., display an error message)
            console.error(xhr.responseText);
        }
    });
}

function showConfirmationPopup(itemId, itemType) {
    const popup = document.getElementById('confirmationPopup');
    const title = document.getElementById('confirmationTitle');
    const message = document.getElementById('confirmationMessage');
    const confirmButton = document.getElementById('confirmActionButton');

    if (popup && title && message && confirmButton) {
        // Set the title and message based on the item type
        title.textContent = `Delete ${itemType}`;
        message.textContent = `Are you sure you want to delete this ${itemType}?`;

        confirmButton.addEventListener('click', function () {
            hidePopup('confirmationPopup');

            if (itemType === 'tasklist') {
                // Call the delete task list function using AJAX
                deleteTaskList(itemId, 'yes');
            } else if (itemType === 'task') {
                // Call the delete task function using AJAX
                deleteTask(itemId);
            }
        });

        showPopup('confirmationPopup');
    }
}

function deleteTaskList(tasklist_id, confirmation){
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;


    // Send an AJAX request to update the tasklist
    $.ajax({
        url: '/delete_task_list/',
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        data: JSON.stringify({
            tasklist_id: tasklist_id,
            confirmation: confirmation,
        }),
        success: function (response) {
            // Handle the success response (e.g., display a message)
            console.log(response.message);

            // Update the tasklist in the UI
            const taskListElement = document.querySelector(`[id="${tasklist_id}-tasklist"]`);
            if (taskListElement) {
                taskListElement.remove();
            }
        },
        error: function (xhr, textStatus, errorThrown) {
            // Handle errors (e.g., display an error message)
            console.error(xhr.responseText);
        }
    });
}

document.addEventListener("DOMContentLoaded", function () {
const createTasklistButton = document.querySelector(".create-tasklist-button");
createTasklistButton.addEventListener("click", function () {
    const projectId = this.getAttribute("data-project-id");
    const popup = document.querySelector("#createTasklistPopup");

    // Set the project ID in the popup form (you can use a hidden input field)
    const projectIdInput = popup.querySelector("input[name='project_id']");
    projectIdInput.value = projectId;

    showPopup("createTasklistPopup");
    });
});

document.addEventListener("DOMContentLoaded", function () {
const createTaskButtons = document.querySelectorAll(".create-task-button");
createTaskButtons.forEach(function (button) {
    button.addEventListener("click", function () {
        const tasklistId = this.getAttribute("data-tasklist-id");
        const popup = document.querySelector("#createTaskPopup");

        // Set the tasklist ID in the popup form (you can use a hidden input field)
        const tasklistIdInput = popup.querySelector("input[name='tasklist_id']");
        tasklistIdInput.value = tasklistId;

        showPopup("createTaskPopup");
        });
    });
});

document.addEventListener("DOMContentLoaded", function () {
    const editTasklistButtons = document.querySelectorAll(".edit-button");
    editTasklistButtons.forEach(function (button) {
        button.addEventListener("click", function () {
            const tasklistId = this.getAttribute("data-task-list");
            const currentName = this.getAttribute("data-task-list-name")
            const popup = document.querySelector("#editTasklistPopup");
            const tasklistNameInput = document.querySelector("#editTasklistName");

            // Set the tasklist ID in the hidden input field
            const tasklistIdInput = document.querySelector("#editTasklistId");
            tasklistIdInput.value = tasklistId;

            // Populate the input field with the current tasklist name
            tasklistNameInput.value = currentName;

            showPopup("editTasklistPopup");
        });
    });

    // Add event listener for form submission
    const editTasklistForm = document.querySelector("#editTasklistForm");
    editTasklistForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const tasklistId = document.querySelector("#editTasklistId").value;
        const newTasklistName = document.querySelector("#editTasklistName").value;

        // Call the editTaskList function with the updated data
        editTaskList(tasklistId, newTasklistName);

        // Close the popup
        hidePopup("editTasklistPopup");
    });
});

</script>
{% endblock content %}
