<!DOCTYPE html>
{% extends 'theme.html' %}


{% block title %}
Project Details
{% endblock title %}


{% block content %}
<a href="/Project"><button class="project-button">Back to Project List</button></a>
<body>
    <h1>{{ project.name }}</h1>
    <p>Description: {{ project.description }}</p>
    <!-- Add more project details here -->
    <h2>Tasklists:</h2>
    <ul>
    {% for tasklist in tasklists %}
        <div class="task-list temp">
            <h3>{{ tasklist.name }}</h2>
            <div class="task-list">
                <h3>Status: <span id="taskListStatus" class="status-not-started">Not Started</span></h3>
            </div>
            <div class="tasks temp">
                {% for task in tasks %}
                    {% if task.task_list == tasklist %}
                        <div class="task">
                            <p><span class="popup-trigger" data-popup-id="popup1">{{ task.task_name }}</span>:<span id="{{ task.id }}-status" class="{{ task.status }}">{{ task.status }}</span></p>
                            <button class="update-status-button" data-status="In Progress" data-task="{{ task.id }}" onclick="updateTaskStatus('{{ task.id }}', 'In Progress')">In Progress</button>
                            <button class="update-status-button" data-status="Done" data-task="{{ task.id }}" onclick="updateTaskStatus('{{ task.id }}', 'Done')">Done</button>
                        </div>
                    {% endif %}
                {% empty %}
                    <h2>No Tasks</h2>
                {% endfor %}
            </div>
            <button href="#" class="create-task-button project-button" data-tasklist-id="{{ tasklist.id }}">Add Task</button>
        </div>
    {% empty %}
        <h2>No Tasklists available</h3>
    {% endfor %}
    </ul>
    <button class="create-tasklist-button project-button" data-project-id="{{ project.id }}">Create new tasklist</button>
    <div class="project-buttons">
        <a href="{% url 'project-update' project.id%}"><button class="project-button">Edit Project</button></a>
        <a href="{% url 'project-delete' project.id %}"><button class="delete-button" >Delete project</button></a>
    </div>
    
</body>

<div class="popup" id="popup1">
<div class="popup-content">
    <ul>
    <li><p>Assigned To: <b>{{ task.assignee }}</b></p></li>
    <li><p>Task: <b>{{ task.name }}</b></p></li>
    <li>
        <p>{{ task.description }} </p>
    </li>
    <li>
        <div class="container">
        <div>
            <button class="update-status-button" data-status="In Progress">In Progress</button>
            <button class="update-status-button" data-status="Done">Done</button>
        </div>
        <h4>{{ task.due_date }} </h4>
        <button class="close-popup">Close</button>
        </div>
    </li>
    </ul>   
</div>
</div>

<div class="popup" id="createTasklistPopup">
<div class="popup-content">
    <h3>Create New Tasklist</h3>
    <form method="post" action="{% url 'create-tasklist' %}">
        {% csrf_token %}
        <!-- Include a hidden input to store the project ID -->
        <input type="hidden" name="project_id" value="">
        <label for="tasklist_name">Tasklist Name:</label>
        <input type="text" name="tasklist_name" id="tasklist_name" required>
        <button type="submit">Create</button>
        <button class="close-popup">Cancel</button>
    </form>
</div>
</div>

<div class="popup" id="createTaskPopup">
<div class="popup-content">
    <h3>Create New Task</h3>
    <form method="post" action="{% url 'create-task' %}">
        {% csrf_token %}
        <!-- Include a hidden input to store the tasklist ID -->
        <input type="hidden" name="tasklist_id" value="{{ tasklist.id }}">
        <label for="task_name">Task Name:</label>
        <input type="text" name="task_name" id="task_name" required>
        <label for="description">Description:</label>
        <textarea name="description" id="description"></textarea>
        <label for="due_date">Due Date:</label>
        <input type="date" name="due_date" id="due_date">
        <label for="priority">Priority:</label>
        <select name="priority" id="priority">
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
        </select>
        <button type="submit">Create</button>
        <button class="close-popup">Cancel</button>
    </form>
</div>
</div>



<script>
const triggers = document.querySelectorAll('.popup-trigger');
const popups = document.querySelectorAll('.popup');
const closeButtons = document.querySelectorAll('.close-popup');

// Function to show a specific popup by ID
function showPopup(popupId) {
    const popup = document.getElementById(popupId);
    if (popup) {
        popup.style.display = 'block';
    }
}

// Function to hide a specific popup by ID
function hidePopup(popupId) {
    const popup = document.getElementById(popupId);
    if (popup) {
        popup.style.display = 'none';
    }
}

// Add click event listeners to all trigger elements
triggers.forEach(trigger => {
    trigger.addEventListener('click', function () {
        const popupId = this.getAttribute('data-popup-id');
        showPopup(popupId);
    });
});

// Add click event listeners to close buttons
closeButtons.forEach(closeButton => {
    closeButton.addEventListener('click', function () {
        const popupId = this.closest('.popup').id;
        hidePopup(popupId);
    });
});



function updateTaskStatus(taskId, newStatus) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // Send an AJAX request to update the task status
    $.ajax({
        url: '/update_task_status/',
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        data: JSON.stringify({
            task_id: taskId,
            new_status: newStatus,
        }),
        success: function (response) {
            // Handle the success response (e.g., display a message)
            console.log(response.message);
            // Update the task status wherever it's displayed
            const buttonToUpdate = document.querySelector(`[data-task="${taskId}"]`);
            // Update the class of the <span> element
            const spanToUpdate = document.getElementById(`${taskId}-status`);
            if (spanToUpdate) {
                spanToUpdate.className = `status-${newStatus}`;
                spanToUpdate.textContent = newStatus;
            }
        },
        error: function (xhr, textStatus, errorThrown) {
            // Handle errors (e.g., display an error message)
            console.error(xhr.responseText);
        }
    });
}


document.addEventListener("DOMContentLoaded", function () {
const createTasklistButton = document.querySelector(".create-tasklist-button");
createTasklistButton.addEventListener("click", function () {
    const projectId = this.getAttribute("data-project-id");
    const popup = document.querySelector("#createTasklistPopup");

    // Set the project ID in the popup form (you can use a hidden input field)
    const projectIdInput = popup.querySelector("input[name='project_id']");
    projectIdInput.value = projectId;

    showPopup("createTasklistPopup");
    });
});

document.addEventListener("DOMContentLoaded", function () {
const createTaskButtons = document.querySelectorAll(".create-task-button");
createTaskButtons.forEach(function (button) {
    button.addEventListener("click", function () {
        const tasklistId = this.getAttribute("data-tasklist-id");
        const popup = document.querySelector("#createTaskPopup");

        // Set the tasklist ID in the popup form (you can use a hidden input field)
        const tasklistIdInput = popup.querySelector("input[name='tasklist_id']");
        tasklistIdInput.value = tasklistId;

        showPopup("createTaskPopup");
        });
    });
});

</script>
{% endblock content %}
